<?php

namespace AppBundle\Repository;

/**
 * RestauranteRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class RestauranteRepository extends \Doctrine\ORM\EntityRepository
{

    /**
     * Devuelve todos los restaurantes de una misma zona.
     *
     * @return mixed
     */
    public function showRestaurantes($codigo_postal)
    {
        $codigo_postal = substr($codigo_postal, 0, 3);
        $query = $this->getEntityManager()
            ->createQuery(
                "SELECT r FROM AppBundle:Restaurante r, AppBundle:Localidad l WHERE r.localidad = l.id AND l.codigoPostal LIKE '$codigo_postal%'"
            );
        $restaurantes = $query->getResult();
        return $restaurantes;
    }

    public function showProductos($idRestaurante)
    {
        $query = $this->getEntityManager()->getConnection()
            ->prepare(
                "SELECT p.id, p.nombre, p.descripcion, p.precio, tp.nombre AS tipoProducto FROM producto p
                LEFT JOIN producto_tipo_producto ON p.id = producto_tipo_producto.idProducto
                LEFT JOIN tipo_producto tp ON producto_tipo_producto.idTipoProducto = tp.id
                WHERE p.idRestaurante = :idRestaurante AND p.disponible = '1' ORDER BY p.nombre ASC"
            );
        $query->bindParam('idRestaurante', $idRestaurante);
        $query->execute();
        return $query->fetchAll();
    }

    /**
     * Obtengo el restaurante con el id pasado (Datos de ambas tablas: Usuario y Restaurante)
     *
     * @param $idRestaurante
     * @return mixed
     */
    public function getInfoRestauranteLogConfigAccount($idRestaurante){
        $stmt = $this->getEntityManager()->getConnection()
                ->prepare("SELECT u.id as usuario_id, r.id as restaurante_id, u.username, u.email, r.nombre, r.cif, r.direccion,
                r.idLocalidad as localidad_id, l.nombre as localidad, r.idProvincia as provincia_id, r.precio_envio,r.telefono
                FROM usuario u LEFT JOIN restaurante r ON r.idUsuario = u.id LEFT JOIN localidad l ON l.id = r.idLocalidad
                WHERE r.idUsuario = :idRestaurante");
        $params = array("idRestaurante" => $idRestaurante);
        $stmt->execute($params);
        return $stmt->fetchAll();
    }


}
